META
    esp_version `1.0`
    author `test-suite`
    date `2025-10-02`
    severity `high`
    platform `linux`
    description `behavior testing`
    control_framework `CIS`
    control `5.2.1-5.2.6`
    esp_scan_id `behavior_testing`
    criticality `high`
    tags `linux,ssh,security`
META_END

DEF
    # Test Case 1: Recursive scan with max depth
    OBJECT config_dir_shallow
        path `/etc/ssh`
        behavior recursive_scan max_depth 2
    OBJECT_END

    # Test Case 2: Recursive scan with hidden files
    OBJECT config_dir_with_hidden
        path `/etc/ssh`
        behavior recursive_scan max_depth 3 include_hidden
    OBJECT_END

    # Test Case 3: Deep recursive scan
    OBJECT security_configs
        path `/etc/security`
        behavior recursive_scan max_depth 5
    OBJECT_END

    # Test Case 4: Single file (no recursion) for comparison
    OBJECT single_file
        path `/etc/passwd`
    OBJECT_END

    # States to validate content
    STATE has_ssh_config
        content string contains `Port`
    STATE_END

    STATE has_pam_config
        content string contains `pam`
    STATE_END

    STATE has_user_data
        content string contains `root`
    STATE_END

    # Test recursive scan finds SSH config
    CRI AND
        CTN file_content
            TEST all all
            OBJECT_REF config_dir_shallow
            STATE_REF has_ssh_config
        CTN_END
    CRI_END

    # Test recursive scan finds PAM configs
    CRI AND
        CTN file_content
            TEST all all
            OBJECT_REF security_configs
            STATE_REF has_pam_config
        CTN_END
    CRI_END

    # Test single file still works
    CRI AND
        CTN file_content
            TEST all all
            OBJECT_REF single_file
            STATE_REF has_user_data
        CTN_END
    CRI_END
DEF_END
