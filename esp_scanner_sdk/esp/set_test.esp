META
    version `1.0.0`
    esp_version `1.0`
    author `ESP-Test-Suite`
    date `2025-11-04`
    severity `high`
    platform `linux`
    description `SET operations test using OBJECT_REF pattern`
    control_framework `TEST`
    control `SET-OPS-FINAL`
    esp_scan_id `set-ops-object-ref`
    criticality `high`
    tags `linux,set-operations,validation,corrected`
META_END

DEF
    # ========================================================================
    # VARIABLES
    # ========================================================================

    VAR passwd_path string `scanfiles/passwd`
    VAR shadow_path string `scanfiles/shadow`
    VAR sshd_config_path string `scanfiles/sshd_config`
    VAR sudoers_path string `scanfiles/sudoers`
    VAR hosts_allow_path string `scanfiles/hosts.allow`
    VAR hosts_deny_path string `scanfiles/hosts.deny`

    VAR required_owner_uid string `0`
    VAR required_group_gid string `0`

    # ========================================================================
    # STATES
    # ========================================================================

    STATE file_exists
        exists boolean = true
    STATE_END

    STATE file_readable
        exists boolean = true
        readable boolean = true
    STATE_END

    STATE secure_ownership
        file_owner string = VAR required_owner_uid
        file_group string = VAR required_group_gid
        exists boolean = true
    STATE_END

    # ========================================================================
    # OBJECTS - Actual files
    # ========================================================================

    OBJECT passwd_file
        path VAR passwd_path
    OBJECT_END

    OBJECT shadow_file
        path VAR shadow_path
    OBJECT_END

    OBJECT sshd_config_file
        path VAR sshd_config_path
    OBJECT_END

    OBJECT sudoers_file
        path VAR sudoers_path
    OBJECT_END

    OBJECT hosts_allow_file
        path VAR hosts_allow_path
    OBJECT_END

    OBJECT hosts_deny_file
        path VAR hosts_deny_path
    OBJECT_END

    # ========================================================================
    # SET OPERATIONS
    # ========================================================================

    SET critical_system_files union
        OBJECT_REF passwd_file
        OBJECT_REF shadow_file
    SET_END

    SET security_config_files union
        OBJECT_REF sshd_config_file
        OBJECT_REF sudoers_file
        OBJECT_REF hosts_allow_file
    SET_END

    SET access_control_files union
        OBJECT_REF hosts_allow_file
        OBJECT_REF hosts_deny_file
    SET_END

    SET all_security_files union
        SET_REF critical_system_files
        SET_REF security_config_files
        SET_REF access_control_files
    SET_END

    SET group_a union
        OBJECT_REF passwd_file
        OBJECT_REF sshd_config_file
        OBJECT_REF sudoers_file
    SET_END

    SET group_b union
        OBJECT_REF sshd_config_file
        OBJECT_REF sudoers_file
        OBJECT_REF hosts_allow_file
    SET_END

    SET common_files intersection
        SET_REF group_a
        SET_REF group_b
    SET_END

    SET all_configs union
        OBJECT_REF sshd_config_file
        OBJECT_REF sudoers_file
        OBJECT_REF hosts_allow_file
    SET_END

    SET exclude_configs union
        OBJECT_REF sudoers_file
    SET_END

    SET remaining_configs complement
        SET_REF all_configs
        SET_REF exclude_configs
    SET_END

    # ========================================================================
    # GLOBAL OBJECTS - Containers for SET_REF
    # These can be referenced with OBJECT_REF in CTN
    # ========================================================================

    OBJECT critical_files_container
        SET_REF critical_system_files
    OBJECT_END

    OBJECT security_configs_container
        SET_REF security_config_files
    OBJECT_END

    OBJECT all_files_container
        SET_REF all_security_files
    OBJECT_END

    OBJECT common_files_container
        SET_REF common_files
    OBJECT_END

    OBJECT remaining_configs_container
        SET_REF remaining_configs
    OBJECT_END

    # ========================================================================
    # TEST 1: Basic UNION via OBJECT_REF
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF file_exists
            OBJECT_REF critical_files_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 2: UNION with Three Operands
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST any all
            STATE_REF file_exists
            OBJECT_REF security_configs_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 3: Nested UNION (3 SET_REF deep)
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST any all
            STATE_REF file_readable
            OBJECT_REF all_files_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 4: INTERSECTION Operation
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF file_exists
            OBJECT_REF common_files_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 5: COMPLEMENT Operation
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF file_exists
            OBJECT_REF remaining_configs_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 6: Mixed OBJECT_REF - Direct and Container
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST any all
            STATE_REF file_exists
            OBJECT_REF passwd_file
            OBJECT_REF security_configs_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 7: Multiple Container References
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST any all
            STATE_REF file_exists
            OBJECT_REF critical_files_container
            OBJECT_REF security_configs_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 8: OR Criteria with Containers
    # ========================================================================

    CRI OR
        CTN file_metadata
            TEST all all
            STATE_REF secure_ownership
            OBJECT_REF critical_files_container
        CTN_END

        CTN file_metadata
            TEST all all
            STATE_REF file_readable
            OBJECT_REF security_configs_container
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 9: Local Object with SET_REF (Alternative Pattern)
    # ========================================================================

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF file_exists
            OBJECT local_set_ref
                SET_REF critical_system_files
            OBJECT_END
        CTN_END
    CRI_END

    # ========================================================================
    # TEST 10: Chained Operations
    # ========================================================================

    SET step1 union
        SET_REF critical_system_files
        SET_REF access_control_files
    SET_END

    SET step2 complement
        SET_REF step1
        SET_REF security_config_files
    SET_END

    OBJECT chained_container
        SET_REF step2
    OBJECT_END

    CRI AND
        CTN file_metadata
            TEST any all
            STATE_REF file_exists
            OBJECT_REF chained_container
        CTN_END
    CRI_END

DEF_END
