# Network Infrastructure Compliance Validation
# ICS Parser Smoke Test #2 - Alternative Grammar Patterns
# Version 1.8.3 - Network Security Focus

META
version `1.8.3`
ics_version `1.0`
author `network-security-team`
date `2024-03-15`
severity `high`
platform `network`
description `Network infrastructure security compliance validation for enterprise environments`
compliance_framework `NIST-Cybersecurity-Framework`
tags `network,infrastructure,security,monitoring`
scan_type `comprehensive`
max_threads 16
scan_timeout 120
enable_deep_scan false
confidence_threshold 0.85
META_END

DEF
# =============================================================================
# NETWORK INFRASTRUCTURE VARIABLES
# =============================================================================

VAR network_segment string `192.168.1.0/24`
VAR gateway_ip string `192.168.1.1`
VAR dns_primary string `8.8.8.8`
VAR vlan_id int 100
VAR bandwidth_limit int 1000000000
VAR ssl_cert_days int 90
VAR monitoring_enabled boolean true
VAR firmware_version version `3.2.1`
VAR certificate_data binary `cert_binary_blob`

# Uninitialized variables for runtime discovery
VAR detected_devices string
VAR active_connections int
VAR threat_level string
VAR last_scan_time int

# =============================================================================
# NETWORK DATA PROCESSING OPERATIONS
# =============================================================================

RUN network_path CONCAT
    VAR network_segment
    literal `/gateway/`
    VAR gateway_ip
RUN_END

RUN ip_components SPLIT
    VAR gateway_ip
    delimiter `.`
RUN_END

RUN subnet_extract SUBSTRING
    VAR network_segment
    start 0
    length 12
RUN_END

RUN device_pattern REGEX_CAPTURE
    VAR detected_devices
    pattern `([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})`
RUN_END

RUN bandwidth_calc ARITHMETIC
    VAR bandwidth_limit
    / 1000000
    * 8
    - 100
    + 50
    % 1000
RUN_END

RUN unique_devices UNIQUE
    VAR detected_devices
RUN_END

RUN device_count COUNT
    VAR active_connections
RUN_END

RUN connection_merge MERGE
    VAR network_path
    VAR ip_components
RUN_END

RUN cert_info_extract EXTRACT
    OBJ ssl_certificate common_name
RUN_END

# =============================================================================
# NETWORK SECURITY STATES
# =============================================================================

STATE firewall_rules_state
    rule_name string starts `ALLOW_`
    source_ip string pattern_match `^10\.|^172\.(1[6-9]|2[0-9]|3[01])\.|^192\.168\.`
    destination_port int >= 1024
    protocol string ieq `TCP`
    action string = `PERMIT`
    enabled boolean = VAR monitoring_enabled all
STATE_END

STATE device_inventory_state
    hostname string not_contains `unknown`
    mac_address string matches `^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$`
    ip_address string contains `.`
    device_type string ine `SUSPICIOUS`
    last_seen int > 0
    firmware string superset_of VAR firmware_version at_least_one
STATE_END

STATE certificate_validation_state
    issuer string not_starts `self-signed`
    expiry_days int >= VAR ssl_cert_days
    key_length int >= 2048
    algorithm string not_ends `MD5`
    revoked boolean != true none
STATE_END

STATE bandwidth_monitoring_state
    current_usage int < VAR bandwidth_calc
    peak_usage int <= VAR bandwidth_limit
    average_latency float < 50.0
    packet_loss float <= 0.1
    congestion_detected boolean = false only_one
STATE_END

# Complex record validation for network topology
STATE network_topology_state
    record record_data
        field topology.core.switches int >= 2 all
        field topology.access.vlans int > VAR vlan_id at_least_one
        field routing.bgp.neighbors string starts `peer_` only_one
        field security.acl.rules int != 0 none
    record_end
STATE_END

# =============================================================================
# NETWORK INFRASTRUCTURE OBJECTS
# =============================================================================

OBJECT core_switch
    device_name `CoreSwitch01`
    management_ip VAR gateway_ip
    snmp_community `private`
    vlan_count VAR vlan_id
    uptime_days 365
OBJECT_END

OBJECT firewall_appliance
    module_name `FortiGate`
    verb `Validate`
    noun `SecurityPolicy`
    module_id `fw_check_v2`
    module_version `2.3.1`

    parameters string
        ConfigPath `/etc/fortinet/config`
        PolicyFile `security_policies.conf`
        LogLevel `INFO`
        EnableAudit true
        MaxPolicies 1000
        ValidationMode `strict`
    parameters_end

    select record_data
        RuleName `rule_name`
        SourceZone `src_zone`
        DestinationZone `dst_zone`
        Action `policy_action`
        TrafficLog `log_enabled`
    select_end

    behavior deep_inspection policy_validation rule_optimization
OBJECT_END

OBJECT ssl_certificate
    common_name `*.company.com`
    issuer_ca `DigiCert`
    expiry_date `2025-12-31`
    key_algorithm `RSA-2048`

    FILTER include
        STATE_REF certificate_validation_state
        STATE_REF device_inventory_state
    FILTER_END
OBJECT_END

OBJECT network_monitor
    monitor_type `SNMP`
    polling_interval 300
    alert_threshold VAR bandwidth_calc
    data_retention VAR ssl_cert_days
OBJECT_END

OBJECT vlan_configuration
    SET_REF critical_network_segments
    vlan_range `100-200`
    trunk_ports `1-24`
OBJECT_END

# =============================================================================
# NETWORK SECURITY SETS
# =============================================================================

SET critical_network_segments union
    OBJECT_REF core_switch
    OBJECT_REF firewall_appliance
    OBJECT_REF ssl_certificate
SET_END

SET monitored_infrastructure intersection
    OBJECT_REF network_monitor
    SET_REF critical_network_segments
SET_END

SET security_exclusions complement
    SET_REF critical_network_segments
    SET_REF monitored_infrastructure
SET_END

SET inline_device_set union
    OBJECT inline_router
        device_type `router`
        model `Cisco_ISR4331`
        ios_version `16.09.04`
        interface_count 8

        parameters record_data
            RoutingProtocol `OSPF`
            AreaId `0.0.0.0`
            NetworkType `broadcast`
        parameters_end

        behavior route_redistribution load_balancing
    OBJECT_END
    OBJECT_REF core_switch
SET_END

SET filtered_devices union
    OBJECT_REF firewall_appliance
    FILTER exclude
        STATE_REF bandwidth_monitoring_state
    FILTER_END
SET_END

# =============================================================================
# NETWORK COMPLIANCE CRITERIA
# =============================================================================

CRI AND

CTN infrastructure_baseline
    TEST all all AND
    STATE_REF firewall_rules_state
    STATE_REF device_inventory_state
    OBJECT_REF core_switch
    OBJECT_REF firewall_appliance
CTN_END

CTN security_policy_validation
    TEST any at_least_one OR
    STATE_REF certificate_validation_state
    STATE_REF network_topology_state
    OBJECT_REF ssl_certificate
    OBJECT_REF vlan_configuration
CTN_END

CTN performance_monitoring
    TEST at_least_one only_one ONE

    STATE_REF bandwidth_monitoring_state
    STATE_REF device_inventory_state

    OBJECT_REF network_monitor
    OBJECT_REF firewall_appliance

    STATE local_interface_state
        interface_name string matches `^(Gi|Fa|Te)[0-9]+/[0-9]+(/[0-9]+)?$`
        interface_status string = `up`
        duplex_mode string ieq `FULL`
        speed_mbps int >= 100
        error_count int <= 10 none
    STATE_END

    STATE local_routing_state
        route_destination string pattern_match `^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]{1,2}$`
        next_hop string != `0.0.0.0`
        metric int < 1000
        route_age int >= 0
    STATE_END

    OBJECT local_monitoring_config
        snmp_enabled VAR monitoring_enabled
        trap_destination VAR gateway_ip
        community_string `monitoring`

        parameters string
            Version `v3`
            SecurityLevel `authPriv`
            AuthProtocol `SHA`
            PrivProtocol `AES`
        parameters_end

        select string
            OID `.1.3.6.1.2.1.2.2.1.10`
            Description `Interface Bytes In`
            DataType `Counter64`
        select_end

        behavior real_time_monitoring threshold_alerting
    OBJECT_END
CTN_END

CRI_END

# Nested compliance validation
CRI OR true

CRI AND
    CTN nested_security_check
        TEST only_one none_satisfy
        STATE_REF certificate_validation_state

        STATE deep_packet_inspection_state
            dpi_enabled boolean = true
            signature_version string >= `2024.01`
            threat_database_updated boolean = VAR monitoring_enabled
            blocked_threats int >= 0 at_least_one
        STATE_END
    CTN_END
CRI_END

CTN compliance_reporting
    TEST none all
    STATE reporting_state
        report_generation boolean = true
        compliance_score float >= 0.8
        last_audit_days int <= 30
        findings_resolved int superset_of VAR active_connections
    STATE_END
CTN_END

CRI_END

# Final validation with set integration
CRI AND
CTN set_reference_validation
    TEST any all
    STATE_REF firewall_rules_state
    OBJECT_REF vlan_configuration
CTN_END
CRI_END

DEF_END
