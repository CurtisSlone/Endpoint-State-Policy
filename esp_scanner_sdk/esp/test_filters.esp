META
    version `1.0.0`
    esp_version `1.0`
    author `filter-test-failing`
    date `2025-11-04`
    severity `high`
    platform `linux`
    description `FILTER test designed to FAIL - shows what gets validated`
    control_framework `TEST`
    control `FILTER-FAIL-1`
    esp_scan_id `filter-failing-test`
    criticality `high`
    tags `linux,filter,test,debug`
META_END

DEF
    # ============================================================================
    # VARIABLES
    # ============================================================================
    VAR sudoers_file string `scanfiles/sudoers`
    VAR impossible_perms string `0000`  # Will never match
    VAR impossible_owner string `99999` # Nonexistent user

    # ============================================================================
    # STATES - Designed to FAIL so we see findings
    # ============================================================================

    # State: File must be readable (will pass)
    STATE is_readable
        readable boolean = true
    STATE_END

    # State: File must be owned by nonexistent user (WILL FAIL)
    STATE impossible_owner_check
        owner string = VAR impossible_owner
    STATE_END

    # State: File must have impossible permissions (WILL FAIL)
    STATE impossible_permissions
        permissions string = VAR impossible_perms
    STATE_END

    # State: File must NOT be readable (WILL FAIL if readable)
    STATE must_not_be_readable
        readable boolean = false
    STATE_END

    # ============================================================================
    # OBJECTS - Some filtered, some not
    # ============================================================================

    # Object 1: No filter - baseline (WILL BE VALIDATED)
    OBJECT sudoers_no_filter
        path VAR sudoers_file
        type `file`
    OBJECT_END

    # Object 2: Filtered by readable (if readable: keep, if not: exclude)
    OBJECT sudoers_readable_filtered
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF is_readable
        FILTER_END
    OBJECT_END

    # Object 3: Filtered by NOT readable (if readable: exclude, if not: keep)
    OBJECT sudoers_unreadable_filtered
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF must_not_be_readable
        FILTER_END
    OBJECT_END

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF impossible_owner_check
            OBJECT_REF sudoers_no_filter
        CTN_END
    CRI_END



    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF impossible_owner_check
            OBJECT_REF sudoers_readable_filtered
        CTN_END
    CRI_END

    CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF impossible_owner_check
            OBJECT_REF sudoers_unreadable_filtered
        CTN_END
    CRI_END

    # Additional object for SET testing
    OBJECT sudoers_copy1
        path VAR sudoers_file
        type `file`
    OBJECT_END

    OBJECT sudoers_copy2
        path VAR sudoers_file
        type `file`
    OBJECT_END

    SET readable_set union
        OBJECT_REF sudoers_copy1
        OBJECT_REF sudoers_copy2
        FILTER include
            STATE_REF is_readable
        FILTER_END
    SET_END

   CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF impossible_permissions
            OBJECT from_set
                SET_REF readable_set
            OBJECT_END
        CTN_END
    CRI_END

    # ============================================================================
    # TEST 6: SET with Exclude Filter (inverted)
    # ============================================================================

    OBJECT sudoers_copy3
        path VAR sudoers_file
        type `file`
    OBJECT_END

    OBJECT sudoers_copy4
        path VAR sudoers_file
        type `file`
    OBJECT_END

    SET excluded_readable_set union
        OBJECT_REF sudoers_copy3
        OBJECT_REF sudoers_copy4
        FILTER exclude
            STATE_REF is_readable
        FILTER_END
    SET_END

   CRI AND
        CTN file_metadata
            TEST all all
            STATE_REF impossible_permissions
            OBJECT from_excluded_set
                SET_REF excluded_readable_set
            OBJECT_END
        CTN_END
    CRI_END

DEF_END
