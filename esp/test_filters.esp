META
    version `1.0.0`
    ics_version `1.0`
    author `filter-advanced-test`
    date `2025-11-02`
    severity `high`
    platform `linux`
    description `Advanced FILTER test with SETs - corrected paths`
    control_framework `TEST`
    control `FILTER-ADV-2`
    ics_scan_id `filter-advanced-corrected`
    criticality `high`
    tags `linux,filter,set,advanced`
META_END

DEF
    # ============================================================================
    # VARIABLES
    # ============================================================================
    VAR sudoers_file string `scanfiles/sudoers`
    VAR root_user string `0`
    VAR secure_perms string `0440`

    # ============================================================================
    # GLOBAL STATES FOR FILTERING
    # ============================================================================
    
    # State: File must be readable and exist
    STATE readable_and_exists
        readable boolean = true
        exists boolean = true
    STATE_END

    # State: File must have secure permissions
    STATE secure_permissions
        permissions string = VAR secure_perms
    STATE_END

    # State: File must be owned by root
    STATE root_owned
        owner string = VAR root_user
    STATE_END

    # State: File size must be reasonable
    STATE reasonable_size
        size int > 100
        size int < 100000
    STATE_END

    # State: Content must contain "Defaults"
    STATE has_defaults
        content string contains `Defaults`
    STATE_END

    # State: Content must NOT contain "NOPASSWD"
    STATE no_nopasswd
        content string not_contains `NOPASSWD`
    STATE_END

    # ============================================================================
    # OBJECTS WITH FILTERS (file_metadata compatible)
    # ============================================================================

    # Object 1: No filter - baseline
    OBJECT sudoers_no_filter
        path VAR sudoers_file
        type `file`
    OBJECT_END

    # Object 2: Only readable files
    OBJECT sudoers_readable_only
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF readable_and_exists
        FILTER_END
    OBJECT_END

    # Object 3: Only root-owned files
    OBJECT sudoers_root_only
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF root_owned
        FILTER_END
    OBJECT_END

    # Object 4: Multiple filter states (AND logic)
    OBJECT sudoers_root_and_readable
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF root_owned
            STATE_REF readable_and_exists
        FILTER_END
    OBJECT_END

    # Object 5: Exclude root-owned files (inverted)
    OBJECT sudoers_not_root
        path VAR sudoers_file
        type `file`
        FILTER exclude
            STATE_REF root_owned
        FILTER_END
    OBJECT_END

    # ============================================================================
    # OBJECTS FOR file_content CTN
    # ============================================================================

    # Object 6: Filter by content - has "Defaults"
    OBJECT sudoers_with_defaults
        path VAR sudoers_file
        type `file`
        FILTER include
            STATE_REF has_defaults
        FILTER_END
    OBJECT_END

    # Object 7: Filter by content - no "NOPASSWD"
    OBJECT sudoers_safe_content
        path VAR sudoers_file
        type `file`
        FILTER exclude
            STATE_REF no_nopasswd
        FILTER_END
    OBJECT_END

    # ============================================================================
    # SET OPERATIONS WITH FILTERS
    # ============================================================================

    # Set 1: Union of multiple objects, filtered for readable
    SET readable_sudoers union
        OBJECT_REF sudoers_no_filter
        OBJECT_REF sudoers_root_only
        FILTER include
            STATE_REF readable_and_exists
        FILTER_END
    SET_END

    # Set 2: Intersection - files that are both root-owned AND readable
    SET secure_sudoers intersection
        OBJECT_REF sudoers_root_only
        OBJECT_REF sudoers_readable_only
    SET_END

    # Set 3: Union with exclude filter
    SET non_root_sudoers union
        OBJECT_REF sudoers_no_filter
        FILTER exclude
            STATE_REF root_owned
        FILTER_END
    SET_END

    # ============================================================================
    # CRITERIA - Testing Different Filter Scenarios
    # ============================================================================

    CRI OR
        # Test 1: file_metadata - No filter (baseline)
        CTN file_metadata
            TEST all all
            STATE_REF reasonable_size
            STATE_REF readable_and_exists
            OBJECT_REF sudoers_no_filter
        CTN_END

        # Test 2: file_metadata - Readable filter
        # If file not readable: existence check fails
        CTN file_metadata
            TEST all all
            STATE_REF secure_permissions
            OBJECT_REF sudoers_readable_only
        CTN_END

        # Test 3: file_metadata - Root-owned filter
        # If file not owned by root: existence check fails
        CTN file_metadata
            TEST all all
            STATE_REF reasonable_size
            OBJECT_REF sudoers_root_only
        CTN_END

        # Test 4: file_metadata - Multiple filter states (AND)
        # Both filter states must pass
        CTN file_metadata
            TEST all all
            STATE_REF secure_permissions
            OBJECT_REF sudoers_root_and_readable
        CTN_END

        # Test 5: file_metadata - Exclude filter
        # If file IS root-owned: filtered out, existence check fails
        # If file NOT root-owned: kept for validation
        CTN file_metadata
            TEST all all
            STATE_REF readable_and_exists
            OBJECT_REF sudoers_not_root
        CTN_END

        # Test 6: file_content - Content filter (include)
        # If file contains "Defaults": kept and validated
        # If file missing "Defaults": filtered out
        CTN file_content
            TEST all all
            STATE_REF no_nopasswd
            OBJECT_REF sudoers_with_defaults
        CTN_END

        # Test 7: file_content - Content filter (exclude)
        # If file has "NOPASSWD": filtered out (inverted logic)
        # If file no "NOPASSWD": kept and validated
        CTN file_content
            TEST all all
            STATE_REF has_defaults
            OBJECT_REF sudoers_safe_content
        CTN_END

        # Test 8: file_metadata - SET with filter
        CTN file_metadata
            TEST at_least_one all
            STATE_REF reasonable_size
            OBJECT set_readable
                SET_REF readable_sudoers
            OBJECT_END
        CTN_END

        # Test 9: file_metadata - SET intersection
        CTN file_metadata
            TEST any all
            STATE_REF secure_permissions
            OBJECT set_intersection
                SET_REF secure_sudoers
            OBJECT_END
        CTN_END

        # Test 10: file_metadata - SET with exclude filter
        CTN file_metadata
            TEST any all
            STATE_REF readable_and_exists
            OBJECT set_non_root
                SET_REF non_root_sudoers
            OBJECT_END
        CTN_END
    CRI_END
DEF_END
